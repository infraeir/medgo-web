image: docker:20.10.16

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  FLUTTER_VERSION: "3.35.4"
  DOCKER_APP_NAME: "medgo-app"
  HEROKU_PRODUCTION_APP_NAME: "medgo-app"
  HEROKU_TESTING_APP_NAME: "medgo-app-testing"

stages:
  - build
  - deploy_testing
  - deploy_production

# ---------- BUILD ----------
build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:dind
  before_script:
    - apk add --no-cache bash curl
    - echo "Gerando .env para ambiente ${CI_COMMIT_BRANCH}"
    - |
      if [ "$CI_COMMIT_BRANCH" == "develop" ]; then
        echo "API_URL=${MEDGO_API_TESTING_URL}" >> .env
        echo "SOCKET_URL=${DIAGNOSES_SOCKET_TESTING_URL}" >> .env
      fi
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        echo "API_URL=${MEDGO_API_PRODUCTION_URL}" >> .env
        echo "SOCKET_URL=${DIAGNOSES_SOCKET_PRODUCTION_URL}" >> .env
      fi
    - cat .env
  script:
    - echo "ðŸš€ Iniciando build do Docker Flutter Web"
    - docker build --network=host -t $DOCKER_APP_NAME .
    - echo "ðŸ“¦ Login no Heroku Container Registry"
    - docker login --username=$HEROKU_USERNAME --password=$HEROKU_API_KEY registry.heroku.com
    - |
      if [ "$CI_COMMIT_BRANCH" == "develop" ]; then
        docker tag $DOCKER_APP_NAME registry.heroku.com/$HEROKU_TESTING_APP_NAME/web
        docker push registry.heroku.com/$HEROKU_TESTING_APP_NAME/web
      fi
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker tag $DOCKER_APP_NAME registry.heroku.com/$HEROKU_PRODUCTION_APP_NAME/web
        docker push registry.heroku.com/$HEROKU_PRODUCTION_APP_NAME/web
      fi
  only:
    - develop
    - main

# ---------- DEPLOY TESTING ----------
deploy_testing:
  stage: deploy_testing
  image: debian:bullseye-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl bash ca-certificates libstdc++6 libc6
    - rm -rf /var/lib/apt/lists/*
    - curl https://cli-assets.heroku.com/install.sh | bash
    - heroku --version
  script:
    - echo "ðŸš€ Publicando imagem no Heroku (Testing)..."
    - heroku container:release web --app $HEROKU_TESTING_APP_NAME
  only:
    - develop
  dependencies:
    - build
  allow_failure: false

# ---------- DEPLOY PRODUCTION ----------
deploy_production:
  stage: deploy_production
  image: debian:bullseye-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends curl bash ca-certificates libstdc++6 libc6
    - rm -rf /var/lib/apt/lists/*
    - curl https://cli-assets.heroku.com/install.sh | bash
    - heroku --version
  script:
    - echo "ðŸš€ Publicando imagem no Heroku (ProduÃ§Ã£o)..."
    - heroku container:release web --app $HEROKU_PRODUCTION_APP_NAME
  only:
    - main
  when: manual
  dependencies:
    - build
  allow_failure: false
